<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Principal Dashboard - TaskFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
   .dashboard-section {
  padding: 2rem;
}
   body { font-family: Arial, sans-serif; margin: 0; background: #f5f6fa; }
    header { background: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; }
    header h1 { color: #0d0d0e; font-size: 22px;  }
    .profile-menu { position: relative; font-weight: bold; cursor: pointer; }
    .profile-menu .dropdown { display: none; position: absolute; right: 0; background: white; min-width: 160px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 5px; }
    .profile-menu:hover .dropdown { display: block; }
    .profile-menu .dropdown a { display: block; padding: 10px 16px; text-decoration: none; color: black; font-size: 14px; }
    .profile-menu .dropdown a:hover { background: #f1f1f1; }
    .container { padding: 20px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn { background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .cards { display: flex; gap: 20px; margin-bottom: 30px; }
    .card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .card h2 { margin: 0; font-size: 28px; }
    .card p { margin: 5px 0 0; font-weight: bold; }
    .blue { background: #e0f2ff; }
    .green { background: #d1fae5; }
    .yellow { background: #fef9c3; }
    .red { background: #fee2e2; }
    .task-table { background: white; border-radius: 10px; padding: 20px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #f1f5f9; }
    .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; }
    .pending { background: #facc15; color: black; }
    .in-progress { background: #60a5fa; }
    .completed { background: #10b981; }
    .overdue { background: #ef4444; }
    .high { color: red; font-weight: bold; }
    .medium { color: orange; font-weight: bold; }
    .low { color: green; font-weight: bold; }
    .filter-bar { display: flex; justify-content: space-between; margin-bottom: 10px; }
    select, input[type="search"] { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    .actions i { margin: 0 5px; cursor: pointer; }
    .logout-link { color: red; font-weight: bold; font-size: 14px; }
    .waiting-for-principal-action {
  background: #a855f7;
  color: white;
}

   /* ... CSS (same as yours, kept intact) ... */
  </style>
</head>
 <body> 

<header class="bg-white shadow py-4 px-6 flex justify-between items-center z-50 relative">
  <h1 class="text-xl font-bold text-gray-800">
    Adhiyamaan College Of Engineering, 
    <small class="text-sm text-gray-500">Hosur</small>
  </h1>

  <div class="flex items-center space-x-4">
    <div class="flex items-center space-x-2 bg-indigo-500 text-white px-4 py-2 rounded-full relative">
      <div class="profile-menu">
        üë§ Principal ‚ñæ
        <div class="dropdown">
          <a href="profile.html"><i class="fas fa-user mr-2"></i>View Profile</a>
          <a href="../loginpage/index.html" class="logout-link"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
        </div>
      </div>
    </div>
  </div>
</header>
<main class="dashboard-section">
<!-- <div class="w-full px-6 py-4 flex flex-col sm:flex-row items-center justify-between bg-white shadow rounded-md mb-6"> -->
  <!-- Allocate Task Button -->
  <!-- Future Action Buttons Placeholder -->
  <div class="mt-3 sm:mt-0 flex gap-3">
    <!--
    <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Reports</button>
    <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Settings</button>
    -->
  </div>
</div>

<section class="flex flex-wrap justify-between gap-6 mb-8 w-full">

  <!-- Total Tasks -->
  <div class="flex-grow basis-0 min-w-[220px] bg-gradient-to-br from-blue-100 to-blue-200 hover:from-blue-200 hover:to-blue-300 text-blue-900 rounded-xl shadow p-6 flex flex-col items-center justify-center transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 cursor-pointer h-[140px]">
    <div class="text-3xl mb-1">üìù</div>
    <h2 id="totalTasks" class="text-2xl font-bold">0</h2>
    <p class="text-sm font-medium">Total Tasks</p>
  </div>

  <!-- Completed -->
  <div class="flex-grow basis-0 min-w-[220px] bg-gradient-to-br from-green-100 to-green-200 hover:from-green-200 hover:to-green-300 text-green-900 rounded-xl shadow p-6 flex flex-col items-center justify-center transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 cursor-pointer h-[140px]">
    <div class="text-3xl mb-1">‚úÖ</div>
    <h2 id="completedTasks" class="text-2xl font-bold">0</h2>
    <p class="text-sm font-medium">Completed</p>
  </div>

  <!-- Pending -->
  <div class="flex-grow basis-0 min-w-[220px] bg-gradient-to-br from-yellow-100 to-yellow-200 hover:from-yellow-200 hover:to-yellow-300 text-yellow-900 rounded-xl shadow p-6 flex flex-col items-center justify-center transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 cursor-pointer h-[140px]">
    <div class="text-3xl mb-1">‚è≥</div>
    <h2 id="pendingTasks" class="text-2xl font-bold">0</h2>
    <p class="text-sm font-medium">Pending</p>
  </div>

  <!-- Overdue -->
  <div class="flex-grow basis-0 min-w-[220px] bg-gradient-to-br from-red-100 to-red-200 hover:from-red-200 hover:to-red-300 text-red-900 rounded-xl shadow p-6 flex flex-col items-center justify-center transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 cursor-pointer h-[140px]">
    <div class="text-3xl mb-1">‚ö†Ô∏è</div>
    <h2 id="overdueTasks" class="text-2xl font-bold">0</h2>
    <p class="text-sm font-medium">Overdue</p>
  </div>

</section>
<button 
  onclick="window.location.href='assign_task.html'" 
  class="my-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-2 py-2 rounded-lg shadow transition-all duration-200">
  + Allocate New Task
</button>

 <button 
    onclick="window.location.href='reports.html'" 
    class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg shadow transition-all duration-200">
    üìä View Reports
  </button>
</div>

<div class="bg-white rounded-lg shadow p-4 mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    
    <!-- Search Box -->
    <div class="flex-1">
      <input 
        type="search" 
        placeholder="üîç Search tasks..." 
        id="searchBox" 
        oninput="filterTable()" 
        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
      />
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3">
      <select 
        id="visibilityFilter" 
        onchange="refreshDashboard()" 
        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
      >
        <option value="active">All Tasks</option>
        <option value="deleted">Deleted from Dashboard</option>
      </select>

      <select 
        id="statusFilter" 
        onchange="filterTable()" 
        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
      >
        <option value="">All Statuses</option>
        <option>pending</option>
        <option>in progress</option>
        <option>completed</option>
        <option>overdue</option>
        <option value="Waiting for Principal Action">Waiting for Principal Approval</option>
      </select>
    </div>
    
  </div>
</div>


    <div class="overflow-x-auto bg-white rounded-lg shadow">
  <table class="min-w-full text-sm text-left text-gray-700">
    <thead class="bg-gray-100 text-gray-600 uppercase text-xs tracking-wider">
      <tr>
        <th class="px-6 py-3">üìù Task Title</th>
        <th class="px-6 py-3">üë• Recipient</th>
        <th class="px-6 py-3">üóìÔ∏è Assigned Date</th>
        <th class="px-6 py-3">üìÖ Due Date</th>
        <th class="px-6 py-3">‚ö° Priority</th>
        <th class="px-6 py-3">üìå Status</th>
        <th class="px-6 py-3">‚öôÔ∏è Actions</th>
      </tr>
    </thead>
    <tbody id="taskList" class="divide-y divide-gray-200">
      <!-- Dynamic rows will be inserted here -->
    </tbody>
  </table>
</div>

  </div>
</div>
</main>
<script>
  
async function refreshDashboard() {
  try {
    await fetch('http://localhost/job_api/job_api/principalbackendapi/update_overdue_tasks.php', { method: 'POST' });
    const visibility = document.getElementById('visibilityFilter').value || 'active';
    const res = await fetch(`http://localhost/job_api/job_api/principalbackendapi/get_dashboard_data.php?visibility=${visibility}`);
    const { stats, tasks } = await res.json();

    document.getElementById('totalTasks').innerText = stats.total;
    document.getElementById('completedTasks').innerText = stats.completed;
    document.getElementById('pendingTasks').innerText = stats.pending;
    document.getElementById('overdueTasks').innerText = stats.overdue;

    const tbody = document.getElementById('taskList');
    tbody.innerHTML = '';

    tasks.forEach(task => {
      const tr = document.createElement('tr');
      const prioClass = task.priority.toLowerCase();
      // Convert actual status to valid CSS class name
const statusClass = task.status.toLowerCase().replace(/\s+/g, '-');

const assignedDate = task.created_at?.split(' ')[0] || 'N/A';

tr.innerHTML = `
  <td>${task.title}</td>
  <td>${task.recipient_name}</td>
  <td>${assignedDate}</td>
  <td>${task.due_date}</td>
  <td><span class="${prioClass}">${task.priority}</span></td>
  <td><span class="tag ${statusClass}">${task.status.toUpperCase()}</span></td>
  <td class="actions">
    <i onclick="editTask(${task.id})">‚úèÔ∏è</i>
    <i onclick="viewTask(${task.id})">üîç</i>
    ${
      visibility === 'deleted'
        ? `<i onclick="restoreTask(${task.id})">üîÅ</i>`
        : `<i onclick="deleteTask(${task.id}, '${task.status}')">üóëÔ∏è</i>`
    }
  </td>
`;

      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error loading dashboard:", err);
  }
}

function editTask(id) {
  window.location.href = `edit_task.html?task_id=${id}`;
}

async function viewTask(id) {
  try {
    const res = await fetch(`http://localhost/job_api/job_api/principalbackendapi/get_task_details.php?id=${id}`);
    const data = await res.json();

    document.getElementById('v_title').innerText = data.title || '';
    document.getElementById('v_description').innerText = data.description || '';
    document.getElementById('v_due_date').innerText = data.due_date || '';
    document.getElementById('v_priority').innerText = data.priority || '';

    const recipientBlock = document.getElementById('v_recipient');
    const statusBlock = document.getElementById('v_status');
    recipientBlock.innerHTML = '';
    statusBlock.innerHTML = '';

    const attachDiv = document.getElementById('v_attachments');
    attachDiv.innerHTML = '';

    // Attachments from task creator
    if (data.attachments?.length) {
      data.attachments.forEach(path => {
        const link = document.createElement('a');
        link.href = `http://localhost/job_api/${path}`;
        link.textContent = path.split('/').pop();
        link.target = "_blank";
        link.style.display = 'block';
        attachDiv.appendChild(link);
      });
    } else {
      attachDiv.innerText = "No attachments.";
    }

    // Handle recipient data (assuming 1 recipient per task)
    if (data.recipients?.length > 0) {
 const r = data.recipients[0];
if (!r || !r.id) {
  alert("Recipient ID missing. Cannot reassign.");
  return;
}

  recipientBlock.innerText = r.recipient_name;
  statusBlock.innerText = r.status;

      if ((r.status === "Waiting for Principal Action" || r.status === "Completed") && r.submission) {
    const subBox = document.createElement('div');
    subBox.style.marginTop = '10px';

    subBox.innerHTML = `
      <hr>
      <p><strong>üìù Submitted Description:</strong> ${r.submission.description}</p>
      <p><strong>üìé Submitted Files:</strong></p>
    `;

    const fileList = document.createElement('div');
    const files = r.submission.files || [];

    files.forEach((filePath, i) => {
  const link = document.createElement('a');
  link.href = `http://localhost/job_api/${filePath.trim()}`;
  link.textContent = `üìé File ${i + 1}`;
  link.className = "attachment-link";
  link.target = "_blank";
  fileList.appendChild(link);
});

    subBox.appendChild(fileList);

    // Show buttons ONLY if status is "Waiting for Principal Action"
    if (r.status === "Waiting for Principal Action") {
      const actionBox = document.createElement('div');
      actionBox.style.marginTop = '15px';

      const approveBtn = document.createElement('button');
      approveBtn.textContent = "‚úÖ Accept & Mark Completed";
      approveBtn.className = "btn";
      approveBtn.onclick = () => handlePrincipalAction(id, r.id, 'Completed');

      const reassignBtn = document.createElement('button');
reassignBtn.textContent = "üîÅ Reassign";
reassignBtn.className = "btn";
reassignBtn.style.marginLeft = '10px';
reassignBtn.onclick = () => {
  const defaultReason = "I am not satisfied with your submission. Please resubmit.";
  handlePrincipalAction(id, r.id, 'Pending', defaultReason);
};




      actionBox.appendChild(approveBtn);
      actionBox.appendChild(reassignBtn);
      subBox.appendChild(actionBox);
    }

    attachDiv.appendChild(subBox);
  }
}

    document.getElementById('viewModal').style.display = 'flex';
  } catch (err) {
    alert("Failed to load task details.");
    console.error(err);
  }
}


let deleteTaskId = null;
let deleteTaskStatus = null;

function deleteTask(id, status) {
  deleteTaskId = id;
  deleteTaskStatus = status.toLowerCase();
  document.getElementById('deleteModal').style.display = 'flex';

  if (deleteTaskStatus === 'completed') {
    document.getElementById('deleteMessage').innerText = "This task is completed. You can only remove it from your dashboard.";
    document.getElementById('btnSoft').style.display = 'inline-block';
    document.getElementById('btnHard').style.display = 'none';
  } else {
    document.getElementById('deleteMessage').innerText = "Choose how you want to delete this task:";
    document.getElementById('btnSoft').style.display = 'inline-block';
    document.getElementById('btnHard').style.display = 'inline-block';
  }
}

function confirmSoftDelete() {
  if (confirm("Are you sure you want to remove this task from your dashboard?")) {
    fetch(`http://localhost/job_api/job_api/principalbackendapi/soft_delete_task.php?id=${deleteTaskId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        closeDeleteModal();
        refreshDashboard();
      })
      .catch(err => {
        alert("Failed to hide task from dashboard.");
        console.error(err);
      });
  }
}

function confirmHardDelete() {
  if (confirm("This will permanently delete the assigned task. Proceed?")) {
    fetch(`http://localhost/job_api/job_api/principalbackendapi/hard_delete_task.php?id=${deleteTaskId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        closeDeleteModal();
        refreshDashboard();
      })
      .catch(err => {
        alert("Failed to delete task.");
        console.error(err);
      });
  }
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

function filterTable() {
  const text = document.getElementById('searchBox').value.toLowerCase();
  const st = document.getElementById('statusFilter').value;
  document.querySelectorAll('#taskList tr').forEach(tr => {
    const rowText = tr.innerText.toLowerCase();
    const stMatch = !st || rowText.includes(st.toLowerCase());
    const textMatch = !text || rowText.includes(text);
    tr.style.display = stMatch && textMatch ? '' : 'none';
  });
}

function restoreTask(id) {
  if (confirm("Are you sure you want to restore this task to your dashboard?")) {
    fetch(`http://localhost/job_api/job_api/principalbackendapi/restore_task.php?id=${id}`, {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      refreshDashboard();
    })
    .catch(err => {
      alert("Failed to restore task.");
      console.error(err);
    });
  }
}



document.addEventListener('DOMContentLoaded', refreshDashboard);
function handlePrincipalAction(taskId, recipientId, newStatus, reason = '') {
  if (newStatus === 'Completed') {
    // Save in global variables for later use
    window._pendingTaskAction = { taskId, recipientId };
    document.getElementById('completionComment').value = '';
    document.getElementById('commentModal').style.display = 'flex';
    return;
  }

  // For other statuses (like Pending), proceed immediately
  sendTaskAction(taskId, recipientId, newStatus, reason);
}

function closeCommentModal() {
  document.getElementById('commentModal').style.display = 'none';
}

function submitCompletionWithComment() {
  const comment = document.getElementById('completionComment').value.trim();
  const { taskId, recipientId } = window._pendingTaskAction || {};

  if (!taskId || !recipientId) return;

  sendTaskAction(taskId, recipientId, 'Completed', comment);
  closeCommentModal();
}

function sendTaskAction(taskId, recipientId, status, reason = '') {
  const body = `task_id=${taskId}&recipient_id=${recipientId}&status=${status}&reason=${encodeURIComponent(reason)}`;

  fetch('http://localhost/job_api/job_api/principalbackendapi/principal_task_action.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      alert(result.message);
      closeModal();
      refreshDashboard();
    } else {
      alert("Failed to update task status.");
    }
  })
  .catch(err => {
    console.error("Request failed:", err);
    alert("Something went wrong.");
  });
}


function closeModal() {
  document.getElementById('viewModal').style.display = 'none';
}

document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const nameContainer = document.getElementById("principalName");

  if (nameContainer) {
    if (user && user.name) {
      nameContainer.childNodes[0].nodeValue = `üë§ ${user.name} ‚ñæ`;
    } else {
      nameContainer.childNodes[0].nodeValue = "üë§ Principal ‚ñæ";
    }
  }
});

nameContainer.innerHTML = `üë§ ${user.name} ‚ñæ` + nameContainer.innerHTML.split("‚ñæ")[1];


 
</script>

<!-- View Task Modal -->
<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-xl shadow-xl relative p-6 space-y-4">
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-500 text-lg font-bold">
      ‚úñ
    </button>

    <h2 class="text-2xl font-semibold text-indigo-700 flex items-center gap-2">
      üìã Task Details
    </h2>

    <div class="space-y-2 text-sm text-gray-700">
      <p><strong>üìå Title:</strong> <span id="v_title" class="text-gray-900 font-medium"></span></p>
      <p><strong>üìù Description:</strong> <span id="v_description" class="text-gray-900"></span></p>
      <p><strong>üë• Recipient:</strong> <span id="v_recipient" class="text-gray-900"></span></p>
      <p><strong>üìÖ Due Date:</strong> <span id="v_due_date" class="text-gray-900"></span></p>
      <p><strong>‚ö° Priority:</strong> <span id="v_priority" class="text-gray-900"></span></p>
      <p><strong>üìå Status:</strong> <span id="v_status" class="text-gray-900"></span></p>
      <p><strong>üìé Attachments:</strong><br><span id="v_attachments" class="block text-gray-900"></span></p>
    </div>
  </div>
</div>


<!-- Delete Task Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-sm rounded-xl shadow-lg p-6 text-center relative">
    <button onclick="closeDeleteModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold">‚úñ</button>

    <h3 class="text-xl font-semibold text-red-600 mb-2">üóëÔ∏è Delete Task</h3>
    <p id="deleteMessage" class="text-gray-700">Are you sure you want to delete this task?</p>

    <div id="deleteActions" class="mt-6 space-y-3">
      <button id="btnSoft" onclick="confirmSoftDelete()" class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded font-medium transition-all">
        üóÇÔ∏è Delete from Dashboard
      </button>
      <button id="btnHard" onclick="confirmHardDelete()" class="w-full bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded font-medium transition-all">
        üóëÔ∏è Permanently Delete Task
      </button>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div id="commentModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-6 relative">
    <button onclick="closeCommentModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold">‚úñ</button>
    <h3 class="text-lg font-bold mb-4 text-indigo-700">üí¨ Share a Note with Your Staff</h3>
    <textarea id="completionComment" rows="4" class="w-full p-3 border border-gray-300 rounded resize-none" placeholder="e.g., Great work! Next time, try to include visuals."></textarea>
    <div class="mt-4 text-right">
      <button onclick="submitCompletionWithComment()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 py-2 rounded">Send</button>
    </div>
  </div>
</div>


</body>
</html>
