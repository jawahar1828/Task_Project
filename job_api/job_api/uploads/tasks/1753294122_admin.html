<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Inter font for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="min-h-screen bg-gray-100 font-inter">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <i class="fas fa-home icon-blue"></i>
                <div>
                    <h1 class="header-title">Task Assignment - Staff Management</h1>
                    <p class="header-subtitle">Add, Edit, Delete, and Manage Staff Members</p>
                </div>
            </div>
            <div class="header-right">
                <i class="fas fa-bell icon-gray cursor-pointer hover-blue"></i>
                <div class="user-profile">
                    <i class="fas fa-user-circle icon-gray"></i>
                    <span class="user-name">Admin User</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Message Display Area -->
            <div id="message-area" class="message-container hidden">
                <span id="message-icon"></span>
                <span id="message-text"></span>
                <button id="close-message" class="message-close-btn">&times;</button>
            </div>

            <!-- Admin Overview -->
            <section class="section-card">
                <h2 class="section-title">Admin Overview</h2>
                <div class="grid-overview">
                    <div class="overview-card">
                        <div class="icon-wrapper bg-blue-100">
                            <i class="fas fa-users icon-blue"></i>
                        </div>
                        <div>
                            <h3 class="card-subtitle">Total Staff</h3>
                            <p class="card-count" id="totalStaffCount">0</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="icon-wrapper bg-purple-100">
                            <i class="fas fa-building icon-purple"></i>
                        </div>
                        <div>
                            <h3 class="card-subtitle">Total Departments</h3>
                            <p class="card-count" id="totalDepartmentsCount">0</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="icon-wrapper bg-green-100">
                            <i class="fas fa-user-check icon-green"></i>
                        </div>
                        <div>
                            <h3 class="card-subtitle">Active Users</h3>
                            <p class="card-count" id="activeUsersCount">0</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="icon-wrapper bg-red-100">
                            <i class="fas fa-user-times icon-red"></i>
                        </div>
                        <div>
                            <h3 class="card-subtitle">Inactive Users</h3>
                            <p class="card-count" id="inactiveUsersCount">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Actions -->
            <section class="section-card">
                <h2 class="section-title">Actions</h2>
                <div class="flex-actions">
                    <button id="addStaffBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span>Add New Staff</span>
                    </button>
                    <button id="addDepartmentBtn" class="btn btn-success">
                        <i class="fas fa-plus mr-2"></i>
                        <span>Add New Department</span>
                    </button>
                </div>
            </section>

            <!-- Staff Directory -->
            <section class="section-card">
                <h2 class="section-title">Staff Directory</h2>
                <div class="card-content">
                    <!-- Filters -->
                    <div class="filter-container">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchTerm" placeholder="Search staff by name or role..." class="input-field">
                        </div>
                        <select id="departmentFilter" class="input-field">
                            <option value="All">All Departments</option>
                            <!-- Departments will be loaded here by JS -->
                        </select>
                        <select id="statusFilter" class="input-field">
                            <option value="All">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>

                    <!-- Staff Table -->
                    <div class="table-container">
                        <table class="staff-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody">
                                <!-- Staff data will be loaded here by JS -->
                                <tr>
                                    <td colspan="6" class="text-center">No staff members found. (Backend for staff listing is not provided)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staffModalTitle" class="modal-title">Add New Staff</h2>
                <span class="close-button" data-modal="staffModal">&times;</span>
            </div>
            <form id="staffForm">
                <input type="hidden" id="staffId">
                <div class="form-group">
                    <label for="username">Name</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role" required>
                        <option value="staff">Staff</option>
                        <option value="faculty">Faculty</option>
                        <option value="hod">HOD</option>
                        <option value="dean">Dean</option>
                        <option value="principal">Principal</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="staffDepartment" name="department" required>
                        <!-- Departments will be loaded here by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-modal="staffModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="staffFormSubmitBtn">Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="departmentModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Department</h2>
                <span class="close-button" data-modal="departmentModal">&times;</span>
            </div>
            <form id="departmentForm">
                <div class="form-group">
                    <label for="departmentName">Department Name</label>
                    <input type="text" id="departmentName" name="departmentName" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-modal="departmentModal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Department</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Utility function to show messages
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            const messageText = document.getElementById('message-text');
            const messageIcon = document.getElementById('message-icon');

            messageArea.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
            messageIcon.innerHTML = ''; // Clear previous icon

            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
                messageIcon.innerHTML = '<i class="fas fa-check-circle mr-2"></i>';
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
                messageIcon.innerHTML = '<i class="fas fa-times-circle mr-2"></i>';
            }
            messageText.textContent = text;
            messageArea.classList.remove('hidden');

            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        document.getElementById('close-message').addEventListener('click', () => {
            document.getElementById('message-area').classList.add('hidden');
        });

        // Function to open modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // Function to close modals
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Event listeners for opening modals
        document.getElementById('addStaffBtn').addEventListener('click', () => {
            document.getElementById('staffForm').reset(); // Clear form
            document.getElementById('staffId').value = ''; // Clear staff ID for new entry
            document.getElementById('staffModalTitle').textContent = 'Add New Staff';
            document.getElementById('staffFormSubmitBtn').textContent = 'Add Staff';
            document.getElementById('passwordGroup').style.display = 'block'; // Show password for new staff

            console.log('Add New Staff button clicked.');
            console.log('allDepartments array length before populating staffDepartment:', allDepartments.length);
            populateDepartmentSelect('staffDepartment'); // <--- This call populates the dropdown
            openModal('staffModal');
        });

        document.getElementById('addDepartmentBtn').addEventListener('click', () => {
            document.getElementById('departmentForm').reset(); // Clear form
            openModal('departmentModal');
        });

        // Event listeners for closing modals
        document.querySelectorAll('.close-button, .btn-secondary').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                if (modalId) {
                    closeModal(modalId);
                }
            });
        });

        // API URLs for your specific PHP files - CORRECTED PATHS
        const ADD_USER_API_URL = 'http://localhost/job_api/adminapi/add_user.php';
        const FETCH_DEPARTMENTS_API_URL = 'http://localhost/job_api/adminapi/fetch_departments.php';

        let allStaff = []; // Will remain empty as no getStaff endpoint is provided
        let allDepartments = [];

        // Fetch Staff Data (Placeholder - requires backend implementation)
        async function fetchStaff() {
            console.warn('Fetching staff is not implemented in the provided PHP backend. Displaying placeholder data.');
            showMessage('Staff listing is not available. Please implement getStaff in your backend.', 'error');
            // You would typically fetch from a getStaff.php here
            // Example:
            /*
            try {
                const response = await fetch('http://localhost/job_api/adminapi/get_staff.php'); // Assuming you create this file
                const data = await response.json();
                if (data.success) {
                    allStaff = data.data;
                    renderStaffTable();
                    updateOverviewCards();
                } else {
                    showMessage(`Error fetching staff: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Network error fetching staff:', error);
                showMessage('Network error fetching staff data.', 'error');
            }
            */
            renderStaffTable(); // Render empty table or placeholder
            updateOverviewCards(); // Update counts based on empty allStaff
        }

        // Fetch Department Data
        async function fetchDepartments() {
            console.log('Attempting to fetch department data from:', FETCH_DEPARTMENTS_API_URL);
            try {
                const response = await fetch(FETCH_DEPARTMENTS_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // This expects an array of strings
                console.log('Departments API response:', data);

                if (Array.isArray(data)) { // Check if the response is an array
                    allDepartments = data; // Data is already an array of names
                    console.log('Departments data received:', allDepartments);
                    populateDepartmentSelect('departmentFilter');
                    populateDepartmentSelect('staffDepartment');
                    updateOverviewCards();
                } else {
                    showMessage(`Error: Unexpected department data format.`, 'error');
                    console.error('Unexpected department data format:', data);
                }
            } catch (error) {
                console.error('Network error fetching departments:', error);
                showMessage('Network error fetching department data. Check console for details.', 'error');
            }
        }

        // Populate department dropdowns
        function populateDepartmentSelect(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) {
                console.error(`Select element with ID '${selectId}' not found.`);
                return;
            }

            console.log(`Populating select ID: ${selectId}, with ${allDepartments.length} departments.`);

            // Clear existing options
            selectElement.innerHTML = '';

            // Add 'All Departments' option only for the filter dropdown
            if (selectId === 'departmentFilter') {
                const allOption = document.createElement('option');
                allOption.value = 'All';
                allOption.textContent = 'All Departments';
                selectElement.appendChild(allOption);
            }

            if (allDepartments.length === 0) {
                const noDeptOption = document.createElement('option');
                noDeptOption.value = '';
                noDeptOption.textContent = 'No Departments Available';
                selectElement.appendChild(noDeptOption);
                selectElement.disabled = true; // Disable if no departments
                return;
            } else {
                selectElement.disabled = false;
            }

            allDepartments.forEach(deptName => { // Iterate over names directly
                const option = document.createElement('option');
                option.value = deptName;
                option.textContent = deptName;
                selectElement.appendChild(option);
            });

            // If it's the staff modal and we are editing, try to pre-select the department
            // Note: Editing staff is not fully supported by add_user.php
            if (selectId === 'staffDepartment' && document.getElementById('staffId').value) {
                const currentDepartment = document.getElementById('staffDepartment').dataset.currentDepartment;
                if (currentDepartment) {
                    selectElement.value = currentDepartment;
                }
            }
        }

        // Render Staff Table (Will show "No staff members found" without getStaff backend)
        function renderStaffTable() {
            const tableBody = document.getElementById('staffTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            const selectedDepartment = document.getElementById('departmentFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;

            const filteredStaff = allStaff.filter(member => {
                const matchesSearch = searchTerm === '' ||
                    member.username.toLowerCase().includes(searchTerm) ||
                    member.role.toLowerCase().includes(searchTerm) ||
                    (member.department && member.department.toLowerCase().includes(searchTerm)) ||
                    member.email.toLowerCase().includes(searchTerm);

                const matchesDepartment = selectedDepartment === 'All' || (member.department && member.department === selectedDepartment);
                const matchesStatus = selectedStatus === 'All' || member.status === selectedStatus;

                return matchesSearch && matchesDepartment && matchesStatus;
            });

            if (filteredStaff.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No staff members found. (Backend for staff listing is not provided)</td></tr>`;
                return;
            }

            filteredStaff.forEach(member => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${member.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.department || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            member.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${member.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-4 edit-btn" data-id="${member.id}"
                            data-username="${member.username}" data-email="${member.email}" data-role="${member.role}"
                            data-department="${member.department}" data-status="${member.status}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${member.id}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            });

            // Attach event listeners to new buttons (these will show messages as backend is missing)
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    showMessage('Editing staff is not fully supported by the current backend (add_user.php).', 'error');
                    // You would populate the form and open the modal here if full update backend was available
                    // For now, just show message.
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    showMessage('Deleting staff is not supported by the current backend.', 'error');
                    // You would show a confirmation modal and call a deleteStaff.php here
                });
            });
        }

        // Custom Confirmation Modal (replaces window.confirm) - still useful for other confirmations
        function showConfirmationModal(message, onConfirm) {
            const modalHtml = `
                <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Confirm Action</h2>
                            <button class="text-gray-500 hover:text-gray-700 close-confirmation-modal">&times;</button>
                        </div>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200 close-confirmation-modal">Cancel</button>
                            <button type="button" class="px-5 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200 confirm-action-btn">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const confirmationModal = document.getElementById('confirmationModal');
            confirmationModal.querySelector('.close-confirmation-modal').addEventListener('click', () => confirmationModal.remove());
            confirmationModal.querySelector('.confirm-action-btn').addEventListener('click', () => {
                onConfirm();
                confirmationModal.remove();
            });
        }


        // Update Overview Cards
        function updateOverviewCards() {
            // These counts will reflect the limited data available from the current backend
            const totalStaff = allStaff.length; // Will be 0
            const totalDepartments = allDepartments.length;
            const activeUsers = allStaff.filter(s => s.status === 'Active').length; // Will be 0
            const inactiveUsers = allStaff.filter(s => s.status === 'Inactive').length; // Will be 0

            document.getElementById('totalStaffCount').textContent = totalStaff;
            document.getElementById('totalDepartmentsCount').textContent = totalDepartments;
            document.getElementById('activeUsersCount').textContent = activeUsers;
            document.getElementById('inactiveUsersCount').textContent = inactiveUsers;
        }

        // Add Staff Form Submission (sends JSON to add_user.php)
        document.getElementById('staffForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const staffId = document.getElementById('staffId').value; // This will be empty for add
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const department = document.getElementById('staffDepartment').value;
            const status = document.getElementById('status').value; // Note: add_user.php doesn't use status directly for user table

            // Prepare data as a JavaScript object to be sent as JSON
            const dataToSend = {
                username: username,
                email: email,
                password: password, // add_user.php handles encryption
                role: role,
                department: department // This is used for 'hod' or 'staff' roles in add_user.php
            };

            // If staffId is present, it means we are trying to update.
            // However, add_user.php does not support update operations.
            if (staffId) {
                showMessage('Update staff is not supported by the current add_user.php backend.', 'error');
                console.warn('Attempted to update staff, but add_user.php only supports adding.');
                return;
            }

            console.log('Sending data to add_user.php:', dataToSend);

            try {
                const response = await fetch(ADD_USER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Crucial for add_user.php
                    },
                    body: JSON.stringify(dataToSend) // Send as JSON string
                });

                const data = await response.json();
                console.log('Response from add_user.php:', data);

                if (response.ok && data.status === 'success') { // add_user.php returns { "status": "success" }
                    showMessage('Staff member added successfully!', 'success');
                    closeModal('staffModal');
                    // fetchStaff(); // No getStaff endpoint, so no refresh here
                } else {
                    showMessage(`Error adding staff: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Network error submitting staff form:', error);
                showMessage('Network error submitting staff data. Check console for details.', 'error');
            }
        });

        // Delete Staff (Placeholder - requires backend implementation)
        async function deleteStaff(id) {
            console.warn('Deleting staff is not implemented in the provided PHP backend.');
            showMessage('Deleting staff is not supported by the current backend.', 'error');
            // You would typically call a delete_staff.php here
        }

        // Add Department Form Submission (Placeholder - requires backend implementation)
        document.getElementById('departmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const departmentName = document.getElementById('departmentName').value;
            console.warn('Adding department is not implemented in the provided PHP backend.');
            showMessage('Adding departments is not supported by the current backend.', 'error');
            closeModal('departmentModal'); // Close modal even if not fully functional
            // You would typically call an add_department.php here
        });

        // Initial data fetch on page load
        window.onload = function() {
            fetchDepartments(); // Fetch departments first
            fetchStaff(); // Will show placeholder message
            // Add event listeners for filters (will only work on placeholder staff data)
            document.getElementById('searchTerm').addEventListener('keyup', renderStaffTable);
            document.getElementById('departmentFilter').addEventListener('change', renderStaffTable);
            document.getElementById('statusFilter').addEventListener('change', renderStaffTable);
        };
    </script>
</body>
</html>
